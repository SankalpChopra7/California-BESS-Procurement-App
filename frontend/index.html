<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CA‑AZ‑TX BESS Procurement Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <!-- Cesium CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/cesium@1.118/Build/Cesium/Widgets/widgets.css"
    rel="stylesheet"
  />

  <!-- Custom Styles -->
  <style>
    html, body { margin:0; padding:0; height:100%; font-family: Arial, sans-serif; }
    #toolbar {
      position:absolute; top:0; left:0; width:100%; height:50px;
      background:#fff; border-bottom:1px solid #ddd;
      display:flex; align-items:center; padding:0 10px; box-sizing:border-box;
      z-index:1000;
    }
    #toolbar input[type="text"] {
      width:200px; padding:6px; margin-right:8px; border:1px solid #ccc; border-radius:4px;
    }
    #toolbar button {
      padding:6px 12px; margin-right:8px;
      background:#007bff; color:#fff; border:none; border-radius:4px;
      cursor:pointer;
    }
    #toolbar button:hover { background:#0056b3; }

    #map, #cesiumContainer {
      position:absolute; top:50px; left:0;
      width:100%; height:calc(100% - 50px);
    }
    #cesiumContainer { display:none; }

    .leaflet-popup-content, .cesium-popup {
      max-height:300px; overflow:auto;
    }
    .leaflet-popup-content h2 { margin:0 0 .5em; font-size:1.1em; }
    .leaflet-popup-content ul { padding-left:1.2em; margin:0 0 .5em; }

    .supplier-icon { background: #28a745; border-radius: 50%; width:20px; height:20px; }
    .project-icon  { background: #dc3545; border-radius: 50%; width:20px; height:20px; }
  </style>
</head>
<body>

  <div id="toolbar">
    <input id="searchBox" type="text" placeholder="Enter county name…">
    <button id="searchBtn">Search</button>
    <button id="toggleBtn">Switch to 3D</button>
  </div>

  <div id="map"></div>
  <div id="cesiumContainer"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Cesium JS -->
  <script src="https://cdn.jsdelivr.net/npm/cesium@1.118/Build/Cesium/Cesium.js"></script>

  <script>
  //———— Utilities ————
  function groupBy(arr, fn) {
    return arr.reduce((acc, x) => {
      const key = fn(x);
      (acc[key] = acc[key]||[]).push(x);
      return acc;
    }, {});
  }
  function flyToCesium(bounds) {
    viewer.camera.flyTo({ destination: Cesium.Rectangle.fromDegrees(bounds.w, bounds.s, bounds.e, bounds.n) });
  }
  function fitLeaflet(map, bounds) {
    map.fitBounds([[bounds.s, bounds.w], [bounds.n, bounds.e]]);
  }

  //———— Load Data ————
  async function loadData() {
    const [suppliers, projects] = await Promise.all([
      fetch('/suppliers').then(r => r.json()),
      fetch('/projects').then(r => r.json())
    ]);
    return { suppliers, projects };
  }

  //———— Leaflet 2D ————
  let leafletMap, leafletMarkers = [];
  function initLeaflet(datasets) {
    const { suppliers, projects } = datasets;
    const all = suppliers.concat(projects);
    // bounding box
    const lats = all.map(d=>d.lat), lons = all.map(d=>d.lon);
    const bounds = { s: Math.min(...lats), n: Math.max(...lats), w: Math.min(...lons), e: Math.max(...lons) };

    leafletMap = L.map('map');
    fitLeaflet(leafletMap, bounds);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' })
     .addTo(leafletMap);

    // Suppliers (blue)
    const supByCounty = groupBy(suppliers, d=>d.county);
    Object.entries(supByCounty).forEach(([county, items]) => {
      const { lat, lon } = items[0];
      let html = `<h2>${county}</h2>`;
      const svcGroups = groupBy(items, i=>i.service_type||'Other');
      Object.entries(svcGroups).forEach(([svc, arr]) => {
        html += `<strong>${svc}:</strong><ul>`;
        arr.forEach(i=>{
          html += `<li>${i.company}`
               +  (i.contact_url?` <a href="${i.contact_url}" target="_blank">Contact</a>`:'')
               +  (i.map_url?` <a href="${i.map_url}" target="_blank">Map</a>`:'')
               +  `</li>`;
        });
        html += `</ul>`;
      });

      const marker = L.marker([lat,lon], { icon: L.divIcon({ className:'supplier-icon', iconSize:[20,20] }) })
        .addTo(leafletMap)
        .bindPopup(html);
      leafletMarkers.push({ county, lat, lon, marker });
    });

    // Projects (red)
    projects.forEach(p => {
      if (p.lat!=null && p.lon!=null) {
        const popup = `<b>${p.project}</b>`;
        L.circleMarker([p.lat,p.lon], { radius:6, color:'red' })
         .addTo(leafletMap)
         .bindPopup(popup);
      }
    });
  }

  //———— Cesium 3D ————
  let viewer, cesiumEntities = [];
  function initCesium(datasets) {
    const { suppliers, projects } = datasets;
    const all = suppliers.concat(projects);

    Cesium.Ion.defaultAccessToken = '';
    viewer = new Cesium.Viewer('cesiumContainer', {
      imageryProvider: new Cesium.UrlTemplateImageryProvider({ url:'https://tile.openstreetmap.org/{z}/{x}/{y}.png' }),
      baseLayerPicker:false, animation:false, timeline:false
    });

    // bounding box
    const longs = all.map(d=>d.lon), lats = all.map(d=>d.lat);
    const bounds = { w:Math.min(...longs), e:Math.max(...longs), s:Math.min(...lats), n:Math.max(...lats) };
    flyToCesium(bounds);

    // Suppliers (blue)
    const supByCounty = groupBy(suppliers, d=>d.county);
    Object.entries(supByCounty).forEach(([county, items]) => {
      const d=items[0];
      const ent = viewer.entities.add({
        position: Cesium.Cartesian3.fromDegrees(d.lon,d.lat),
        point: { pixelSize:10, color:Cesium.Color.BLUE },
        description: (()=>{
          let desc=`<h2>${county}</h2>`;
          const svcG=groupBy(items,i=>i.service_type||'Other');
          Object.entries(svcG).forEach(([svc,arr])=>{
            desc+=`<strong>${svc}</strong><ul>`;
            arr.forEach(i=>{
              desc+=`<li>${i.company}`
                    + (i.contact_url?`<br/><a href="${i.contact_url}" target="_blank">Contact</a>`:'')
                    + (i.map_url?`<br/><a href="${i.map_url}" target="_blank">Map</a>`:'')
                    + `</li>`;
            });
            desc+=`</ul>`;
          });
          return desc;
        })()
      });
      cesiumEntities.push({ county, ent, lat:d.lat, lon:d.lon });
    });

    // Projects (red)
    projects.forEach(p=>{
      if(p.lat!=null && p.lon!=null) {
        const ent = viewer.entities.add({
          position: Cesium.Cartesian3.fromDegrees(p.lon,p.lat),
          point: { pixelSize:10, color:Cesium.Color.RED },
          description: `<b>${p.project}</b>`
        });
        cesiumEntities.push({ county:p.project, ent, lat:p.lat, lon:p.lon });
      }
    });
  }

  //———— Search ————
  function doSearch(term) {
    term = term.trim().toLowerCase(); if(!term) return;
    const m = leafletMarkers.find(x=>x.county.toLowerCase()===term);
    if(m) { fitLeaflet(leafletMap,{s:m.lat-0.5,n:m.lat+0.5,w:m.lon-0.5,e:m.lon+0.5}); m.marker.openPopup(); }
    const c = cesiumEntities.find(x=>x.county.toLowerCase()===term);
    if(c) { flyToCesium({w:c.lon-1,e:c.lon+1,s:c.lat-1,n:c.lat+1}); viewer.selectedEntity=c.ent; }
  }

  //———— Toggle ————
  document.getElementById('toggleBtn').onclick = ()=>{
    const m=document.getElementById('map'), c=document.getElementById('cesiumContainer'), b=document.getElementById('toggleBtn');
    if(c.style.display==='none'){m.style.display='none';c.style.display='block';b.textContent='Switch to 2D';}
    else {c.style.display='none';m.style.display='block';b.textContent='Switch to 3D';}
  };
  document.getElementById('searchBtn').onclick = ()=>doSearch(document.getElementById('searchBox').value);

  //———— Bootstrap ————
  (async()=>{
    const data = await loadData();
    initLeaflet(data);
    initCesium(data);
  })();
  </script>
</body>
</html>